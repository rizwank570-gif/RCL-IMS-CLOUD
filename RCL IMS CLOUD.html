<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redcliffe Labs - Cloud Inventory Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --redcliffe-maroon: #8b0000;
            --redcliffe-red: #e31e24;
        }
        .bg-redcliffe { background-color: var(--redcliffe-red); }
        .text-redcliffe { color: var(--redcliffe-red); }
        .border-redcliffe { border-color: var(--redcliffe-red); }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.7); z-index: 9999;
            display: none; align-items: center; justify-content: center;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">

    <div id="loading" class="loading-overlay">
        <div class="flex flex-col items-center bg-white p-6 rounded-xl shadow-xl">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-redcliffe"></div>
            <p class="mt-4 font-bold text-gray-700">Syncing with Cloud...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="h-10 flex items-center bg-gray-50 px-2 rounded border border-gray-100">
                            <img src="https://lh3.googleusercontent.com/d/1rWGnTk485-dqc_ADtLn_RuSmDzgomV0U" 
                                 alt="Redcliffe Labs Logo" 
                                 class="h-8 w-auto object-contain"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div style="display:none;" class="items-center space-x-2">
                                <div class="w-8 h-8 bg-redcliffe rounded-full flex items-center justify-center text-white font-bold text-xs">RL</div>
                                <span class="font-bold text-gray-800">Redcliffe Labs</span>
                            </div>
                        </div>
                        <span class="text-gray-400 font-light text-lg ml-3 border-l pl-3 border-gray-200">IMS Cloud</span>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-4 text-sm font-medium">
                    <button onclick="showTab('dashboard')" class="nav-link px-3 py-2 text-gray-700 hover:text-redcliffe transition">Dashboard</button>
                    <button onclick="showTab('masters')" class="nav-link px-3 py-2 text-gray-700 hover:text-redcliffe transition">Masters</button>
                    <button onclick="showTab('inward')" class="nav-link px-3 py-2 text-gray-700 hover:text-redcliffe transition">Inward Entry</button>
                    <button onclick="showTab('outward')" class="nav-link px-3 py-2 text-gray-700 hover:text-redcliffe transition">Outward/Issue</button>
                    <button onclick="showTab('inventory')" class="nav-link px-3 py-2 text-redcliffe font-bold">Live Inventory</button>
                    <button onclick="syncData()" class="ml-4 bg-gray-100 p-2 rounded-full hover:bg-gray-200" title="Refresh Cloud Data">üîÑ</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-6">

        <!-- DASHBOARD TAB -->
        <section id="tab-dashboard" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-gray-500 text-sm uppercase font-bold">Total Hubs</p>
                    <h3 id="stat-hubs" class="text-3xl font-bold mt-1">0</h3>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                    <p class="text-gray-500 text-sm uppercase font-bold">Cloud Sync</p>
                    <h3 id="stat-sync" class="text-lg font-bold mt-1 text-green-600">Connected</h3>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-redcliffe">
                    <p class="text-gray-500 text-sm uppercase font-bold">Total Stock Value</p>
                    <h3 id="stat-value" class="text-3xl font-bold mt-1">‚Çπ 0</h3>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-xl font-bold mb-4">Quick Cloud Actions</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="showTab('inward')" class="p-4 bg-gray-50 rounded-lg hover:bg-redcliffe hover:text-white transition group">
                        <div class="font-semibold">New Inward</div>
                        <div class="text-xs text-gray-400 group-hover:text-red-100">Log incoming stock</div>
                    </button>
                    <button onclick="showTab('outward')" class="p-4 bg-gray-50 rounded-lg hover:bg-redcliffe hover:text-white transition group">
                        <div class="font-semibold">Issue Material</div>
                        <div class="text-xs text-gray-400 group-hover:text-red-100">Camps & Clinics</div>
                    </button>
                    <button onclick="syncData()" class="p-4 bg-blue-50 rounded-lg hover:bg-blue-600 hover:text-white transition group text-left">
                        <div class="font-semibold">Refresh Data</div>
                        <div class="text-xs text-blue-400 group-hover:text-blue-100">Sync with Sheets</div>
                    </button>
                </div>
            </div>
        </section>

        <!-- MASTERS TAB -->
        <section id="tab-masters" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Hub Master -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold mb-4">üè¢ Hub Master</h3>
                    <form id="hubForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="hubName" placeholder="Hub Name" class="p-2 border rounded w-full" required>
                            <input type="text" id="hubLocation" placeholder="Location/City" class="p-2 border rounded w-full" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="hubSpoc" placeholder="SPOC Name" class="p-2 border rounded w-full" required>
                            <input type="tel" id="hubNumber" placeholder="SPOC Mobile" class="p-2 border rounded w-full" required>
                        </div>
                        <textarea id="hubAddress" placeholder="Full Address" class="p-2 border rounded w-full h-20" required></textarea>
                        <button type="submit" class="w-full bg-redcliffe text-white py-2 rounded font-semibold hover:bg-red-800">Add Hub to Cloud</button>
                    </form>
                    <div class="mt-6 overflow-x-auto max-h-60">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr><th class="p-2 text-left">Hub Name</th><th class="p-2 text-left">Location</th></tr>
                            </thead>
                            <tbody id="hubList"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Material Master -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold mb-4">üì¶ Material Master</h3>
                    <form id="materialForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="matName" placeholder="Material Name" class="p-2 border rounded w-full" required>
                            <select id="matCategory" class="p-2 border rounded w-full" required>
                                <option value="">Select Category</option>
                                <option value="Stationery">Stationery</option>
                                <option value="Medical Consumables">Medical Consumables</option>
                                <option value="Kits">Kits</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Equipment">Equipment</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="matPrice" placeholder="Unit Price (‚Çπ)" class="p-2 border rounded w-full" required>
                            <input type="text" id="matUom" placeholder="UOM" class="p-2 border rounded w-full" required>
                        </div>
                        <button type="submit" class="w-full bg-redcliffe text-white py-2 rounded font-semibold hover:bg-red-800">Add Material to Cloud</button>
                    </form>
                    <div class="mt-6 overflow-x-auto max-h-60">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr><th class="p-2 text-left">Name</th><th class="p-2 text-left">Price</th></tr>
                            </thead>
                            <tbody id="materialList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- INWARD ENTRY TAB -->
        <section id="tab-inward" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-xl font-bold mb-6">Inward Material Entry</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 border-r pr-0 lg:pr-8">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Inward Type</label>
                            <select id="inwardType" onchange="toggleInwardSource()" class="w-full p-2 border rounded bg-gray-50">
                                <option value="Standard">Standard Dispatch</option>
                                <option value="NoidaWarehouse">Noida Warehouse</option>
                                <option value="CampReturn">Return from Camp</option>
                                <option value="ClinicReturn">Return from Clinic</option>
                            </select>
                        </div>

                        <div id="sourceDetails" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg border-l-4 border-blue-500">
                            <div id="standardSource"><input type="text" id="dispatchFrom" placeholder="Dispatched From" class="w-full p-2 border rounded"></div>
                            <div id="noidaSource" class="hidden"><input type="text" id="noidaChallan" placeholder="Challan Number" class="w-full p-2 border rounded"></div>
                            <div id="campSource" class="hidden space-y-2">
                                <input type="text" id="campCode" placeholder="Camp Code" class="w-full p-2 border rounded">
                                <input type="text" id="campClientName" placeholder="Client Name" class="w-full p-2 border rounded">
                            </div>
                            <div id="clinicSource" class="hidden"><input type="text" id="clinicClientName" placeholder="Clinic Client Name" class="w-full p-2 border rounded"></div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Delivery Hub</label>
                            <select id="inwardHub" class="w-full p-2 border rounded hub-select"></select>
                        </div>

                        <h4 class="font-bold mb-2">Add Items</h4>
                        <div class="space-y-2">
                            <select id="cartMaterial" class="w-full p-2 border rounded mat-select"></select>
                            <input type="number" id="cartQty" placeholder="Quantity" class="w-full p-2 border rounded">
                            <button onclick="addToCart('inward')" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">+ Add to Cart</button>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <h3 class="font-bold text-lg mb-4">Inward Cart</h3>
                        <div class="overflow-x-auto border rounded-lg mb-4">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr><th class="p-3 text-left">Material</th><th class="p-3 text-right">Qty</th><th class="p-3 text-right">Total</th><th class="p-3 text-center">Action</th></tr>
                                </thead>
                                <tbody id="inwardCartBody"><tr><td colspan="4" class="p-8 text-center text-gray-400">Cart is empty</td></tr></tbody>
                            </table>
                        </div>
                        <div class="flex justify-end space-x-4 items-center">
                            <div class="text-xl font-bold">Total: ‚Çπ<span id="inwardTotal">0</span></div>
                            <button onclick="processTransaction('inward')" class="bg-redcliffe text-white px-8 py-3 rounded-lg font-bold hover:bg-red-800 shadow-lg">Finalize Inward Entry</button>
                        </div>
                    </div>
                </div>
                <div class="mt-12 overflow-x-auto">
                    <h3 class="font-bold mb-4">Cloud Inward History</h3>
                    <table class="w-full text-xs text-left border" id="inward-history-table">
                        <thead class="bg-gray-50"><tr><th class="p-2">Date</th><th class="p-2">Type</th><th class="p-2">Source</th><th class="p-2">Hub</th><th class="p-2">Items</th></tr></thead>
                        <tbody id="inwardHistoryBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- OUTWARD / ISSUE TAB -->
        <section id="tab-outward" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-xl font-bold mb-6">Material Issue (Outward)</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 border-r pr-0 lg:pr-8">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Issue To</label>
                            <select id="outwardType" onchange="toggleOutwardDest()" class="w-full p-2 border rounded bg-gray-50">
                                <option value="Camp">Camp</option>
                                <option value="Clinic">Clinic</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Issue From Hub</label>
                            <select id="outwardHub" class="w-full p-2 border rounded hub-select"></select>
                        </div>
                        <div id="outwardDestDetails" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            <div id="campDest" class="space-y-4">
                                <input type="text" id="oCampCode" placeholder="Camp Code" class="w-full p-2 border rounded">
                                <input type="text" id="oCampClient" placeholder="Client Name" class="w-full p-2 border rounded">
                                <input type="text" id="oCampCity" placeholder="City" class="w-full p-2 border rounded">
                                <input type="text" id="oCampAddress" placeholder="Address" class="w-full p-2 border rounded">
                                <input type="text" id="oCampSPOC" placeholder="SPOC Name" class="w-full p-2 border rounded">
                                <input type="text" id="oCampSPOCNumber" placeholder="SPOC Number" class="w-full p-2 border rounded">
                            </div>
                            <div id="clinicDest" class="hidden"><input type="text" id="oClinicClient" placeholder="Clinic Name" class="w-full p-2 border rounded"></div>
                            <input type="text" id="oRequestBy" placeholder="Material Requested By" class="w-full p-2 border rounded font-semibold border-blue-200">
                        </div>
                        <h4 class="font-bold mb-2">Add Items</h4>
                        <div class="space-y-2">
                            <select id="outCartMaterial" class="w-full p-2 border rounded mat-select"></select>
                            <input type="number" id="outCartQty" placeholder="Quantity" class="w-full p-2 border rounded">
                            <button onclick="addToCart('outward')" class="w-full bg-orange-600 text-white py-2 rounded hover:bg-orange-700">+ Add to Cart</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <h3 class="font-bold text-lg mb-4">Outward Cart</h3>
                        <div class="overflow-x-auto border rounded-lg mb-4">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100"><tr><th class="p-3 text-left">Material</th><th class="p-3 text-right">Qty</th><th class="p-3 text-center">Action</th></tr></thead>
                                <tbody id="outwardCartBody"><tr><td colspan="3" class="p-8 text-center text-gray-400">Cart is empty</td></tr></tbody>
                            </table>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="processTransaction('outward')" class="bg-redcliffe text-white px-8 py-3 rounded-lg font-bold hover:bg-red-800 shadow-lg">Finalize Issue Material</button>
                        </div>
                    </div>
                </div>
                <div class="mt-12 overflow-x-auto">
                    <h3 class="font-bold mb-4">Cloud Outward History</h3>
                    <table class="w-full text-xs text-left border" id="outward-history-table">
                        <thead class="bg-gray-50"><tr><th class="p-2">Date</th><th class="p-2">To</th><th class="p-2">Destination</th><th class="p-2">Requested By</th><th class="p-2">Hub</th><th class="p-2">Items</th></tr></thead>
                        <tbody id="outwardHistoryBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- LIVE INVENTORY TAB -->
        <section id="tab-inventory" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Live Cloud Inventory</h2>
                    <select id="inventoryHubFilter" onchange="renderInventory()" class="p-2 border rounded bg-gray-50 hub-select">
                        <option value="all">All Hubs</option>
                    </select>
                </div>
                <div class="overflow-x-auto border rounded-xl">
                    <table id="inventory-table" class="w-full text-sm">
                        <thead class="bg-gray-800 text-white">
                            <tr><th>Hub Name</th><th>Material</th><th>Category</th><th class="text-right">Stock</th><th>UOM</th><th class="text-right">Value</th></tr>
                        </thead>
                        <tbody id="inventoryBody" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="toast" class="fixed bottom-5 right-5 hidden px-6 py-3 rounded-lg shadow-2xl text-white font-bold z-[100]"></div>

    <script>
        /** CONFIGURATION: Paste your Google Web App URL here **/
        const SHEET_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-qnaIIZARn0nQiMkML7K3dmdN4MMEWOlG-7rhr0GmrBpMNsSUZXvO-JPpXWuY2Lzl/exec";

        // Local State
        let hubs = [];
        let materials = [];
        let inventory = {};
        let inwardHistory = [];
        let outwardHistory = [];
        let activeInwardCart = [];
        let activeOutwardCart = [];

        // App Initializer
        window.onload = function() {
            syncData();
        };

        async function syncData() {
            if (!SHEET_SCRIPT_URL.startsWith("https")) {
                toast("Please set the SHEET_SCRIPT_URL first!", "error");
                return;
            }
            showLoading(true);
            try {
                const response = await fetch(`${SHEET_SCRIPT_URL}?action=getData`);
                const data = await response.json();
                
                hubs = data.hubs || [];
                materials = data.materials || [];
                inventory = data.inventory || {};
                inwardHistory = data.inwards || [];
                outwardHistory = data.outwards || [];

                updateDropdowns();
                renderMasters();
                renderInventory();
                renderHistory();
                updateDashboardStats();
                toast("Cloud Data Synced");
            } catch (err) {
                console.error(err);
                toast("Sync failed. Check App Script Deployment.", "error");
            } finally {
                showLoading(false);
            }
        }

        async function saveMaster(type, data) {
            showLoading(true);
            try {
                await fetch(SHEET_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'saveMaster', type, data })
                });
                toast(`Saving ${type}...`);
                setTimeout(syncData, 2000);
            } catch (err) { toast("Error saving master", "error"); }
        }

        async function processTransaction(type) {
            const hubId = document.getElementById(type === 'inward' ? 'inwardHub' : 'outwardHub').value;
            const cart = type === 'inward' ? activeInwardCart : activeOutwardCart;

            if(!hubId || cart.length === 0) return toast("Missing details or empty cart", "error");

            let sourceInfo = "";
            let reqBy = "";

            if(type === 'inward') {
                const itype = document.getElementById('inwardType').value;
                if(itype === 'Standard') sourceInfo = document.getElementById('dispatchFrom').value;
                else if(itype === 'NoidaWarehouse') sourceInfo = "Challan: " + document.getElementById('noidaChallan').value;
                else if(itype === 'CampReturn') sourceInfo = "Camp: " + document.getElementById('campCode').value;
                else sourceInfo = "Clinic: " + document.getElementById('clinicClientName').value;
            } else {
                reqBy = document.getElementById('oRequestBy').value;
                if(!reqBy) return toast("Requester name required", "error");
                const otype = document.getElementById('outwardType').value;
                sourceInfo = otype === 'Camp' ? document.getElementById('oCampCode').value : document.getElementById('oClinicClient').value;
            }

            showLoading(true);
            try {
                await fetch(SHEET_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        action: 'transaction',
                        type, hubId, sourceInfo, reqBy,
                        items: cart,
                        date: new Date().toLocaleString()
                    })
                });
                if(type === 'inward') activeInwardCart = []; else activeOutwardCart = [];
                renderCart(type);
                toast("Submitting to Cloud...");
                setTimeout(syncData, 2500);
            } catch (err) { toast("Transaction failed", "error"); }
        }

        // Feature: Cart Logic
        function addToCart(transType) {
            const matId = document.getElementById(transType === 'inward' ? 'cartMaterial' : 'outCartMaterial').value;
            const qty = parseInt(document.getElementById(transType === 'inward' ? 'cartQty' : 'outCartQty').value);
            if(!matId || isNaN(qty) || qty <= 0) return toast("Invalid qty", "error");
            const mat = materials.find(m => m.id == matId);
            const cart = transType === 'inward' ? activeInwardCart : activeOutwardCart;
            cart.push({ ...mat, qty });
            renderCart(transType);
        }

        function renderCart(type) {
            const cart = type === 'inward' ? activeInwardCart : activeOutwardCart;
            const body = document.getElementById(type + 'CartBody');
            let total = 0;
            if(cart.length === 0) {
                body.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400">Cart is empty</td></tr>`;
                if(type === 'inward') document.getElementById('inwardTotal').innerText = '0';
                return;
            }
            body.innerHTML = cart.map((item, idx) => {
                total += (item.qty * item.price);
                return `<tr class="border-b"><td class="p-3">${item.name}</td><td class="p-3 text-right">${item.qty}</td>${type==='inward'?`<td class="p-3 text-right">‚Çπ${item.qty*item.price}</td>`:''} <td class="p-3 text-center"><button onclick="removeFromCart('${type}', ${idx})">‚úï</button></td></tr>`;
            }).join('');
            if(type === 'inward') document.getElementById('inwardTotal').innerText = total.toLocaleString();
        }

        function removeFromCart(type, idx) {
            if(type === 'inward') activeInwardCart.splice(idx, 1); else activeOutwardCart.splice(idx, 1);
            renderCart(type);
        }

        // Feature: UI Rendering
        function renderMasters() {
            document.getElementById('hubList').innerHTML = hubs.map(h => `<tr class="border-b"><td class="p-2">${h.name}</td><td class="p-2">${h.location}</td></tr>`).join('');
            document.getElementById('materialList').innerHTML = materials.map(m => `<tr class="border-b"><td class="p-2">${m.name}</td><td class="p-2">‚Çπ${m.price}</td></tr>`).join('');
        }

        function renderInventory() {
            const filter = document.getElementById('inventoryHubFilter').value;
            const body = document.getElementById('inventoryBody');
            let html = "";
            let totalVal = 0;
            hubs.forEach(hub => {
                if(filter !== 'all' && hub.id != filter) return;
                materials.forEach(mat => {
                    const key = `${hub.id}_${mat.id}`;
                    const qty = inventory[key] || 0;
                    if(qty > 0) {
                        const val = qty * mat.price;
                        totalVal += val;
                        html += `<tr><td class="p-3">${hub.name}</td><td class="p-3">${mat.name}</td><td class="p-3">${mat.category}</td><td class="text-right p-3 font-bold">${qty}</td><td class="p-3">${mat.uom}</td><td class="text-right p-3">‚Çπ${val}</td></tr>`;
                    }
                });
            });
            body.innerHTML = html;
            document.getElementById('stat-value').innerText = "‚Çπ " + totalVal.toLocaleString();
        }

        function renderHistory() {
            document.getElementById('inwardHistoryBody').innerHTML = inwardHistory.slice(0, 5).map(h => `<tr><td class="p-2">${h.date}</td><td class="p-2">${h.type}</td><td class="p-2">${h.sourceInfo}</td><td class="p-2">${h.hubName}</td><td class="p-2">${h.items}</td></tr>`).join('');
            document.getElementById('outwardHistoryBody').innerHTML = outwardHistory.slice(0, 5).map(h => `<tr><td class="p-2">${h.date}</td><td class="p-2">${h.to}</td><td class="p-2">${h.dest}</td><td class="p-2">${h.req}</td><td class="p-2">${h.hub}</td><td class="p-2">${h.items}</td></tr>`).join('');
        }

        function updateDropdowns() {
            const hSel = document.querySelectorAll('.hub-select');
            const mSel = document.querySelectorAll('.mat-select');
            hSel.forEach(s => s.innerHTML = (s.id==='inventoryHubFilter'?'<option value="all">All Hubs</option>':'<option value="">Select Hub</option>') + hubs.map(h=>`<option value="${h.id}">${h.name}</option>`).join(''));
            mSel.forEach(s => s.innerHTML = '<option value="">Select Material</option>' + materials.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''));
        }

        function updateDashboardStats() {
            document.getElementById('stat-hubs').innerText = hubs.length;
        }

        // Feature: UI Toggles
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + id).classList.remove('hidden');
        }

        function toggleInwardSource() {
            const v = document.getElementById('inwardType').value;
            ['standardSource','noidaSource','campSource','clinicSource'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            if(v==='Standard') document.getElementById('standardSource').classList.remove('hidden');
            else if(v==='NoidaWarehouse') document.getElementById('noidaSource').classList.remove('hidden');
            else if(v==='CampReturn') document.getElementById('campSource').classList.remove('hidden');
            else document.getElementById('clinicSource').classList.remove('hidden');
        }

        function toggleOutwardDest() {
            const v = document.getElementById('outwardType').value;
            document.getElementById('campDest').classList.toggle('hidden', v!=='Camp');
            document.getElementById('clinicDest').classList.toggle('hidden', v!=='Clinic');
        }

        function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
        
        function toast(msg, type = 'success') {
            const el = document.getElementById('toast');
            el.innerText = msg;
            el.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-2xl text-white font-bold z-[100] ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        document.getElementById('hubForm').onsubmit = function(e) {
            e.preventDefault();
            const data = { id: Date.now(), name: document.getElementById('hubName').value, location: document.getElementById('hubLocation').value };
            saveMaster('Hub', data);
            e.target.reset();
        };

        document.getElementById('materialForm').onsubmit = function(e) {
            e.preventDefault();
            const data = { 
                id: Date.now(), 
                name: document.getElementById('matName').value, 
                category: document.getElementById('matCategory').value,
                price: document.getElementById('matPrice').value,
                uom: document.getElementById('matUom').value
            };
            saveMaster('Material', data);
            e.target.reset();
        };

    </script>
</body>
</html>