<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redcliffe Labs - Cloud Inventory Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --redcliffe-maroon: #8b0000;
            --redcliffe-red: #e31e24;
        }
        .bg-redcliffe { background-color: var(--redcliffe-red); }
        .text-redcliffe { color: var(--redcliffe-red); }
        .border-redcliffe { border-color: var(--redcliffe-red); }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.85); z-index: 9999;
            display: none; align-items: center; justify-content: center;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1ff; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">

    <div id="loading" class="loading-overlay">
        <div class="flex flex-col items-center bg-white p-8 rounded-xl shadow-2xl border border-red-200">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-redcliffe"></div>
            <p class="mt-4 font-bold text-lg text-gray-700">Syncing with Cloud...</p>
            <p class="text-sm text-gray-500 mt-1">Please wait, this may take a few seconds.</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <!-- Logo/Title -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="h-10 flex items-center bg-gray-50 px-2 rounded border border-gray-100">
                            <img src="https://lh3.googleusercontent.com/d/1rWGnTk485-dqc_ADtLn_RuSmDzgomV0U" 
                                 alt="Redcliffe Labs Logo" 
                                 class="h-8 w-auto object-contain"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div style="display:none;" class="items-center space-x-2">
                                <div class="w-8 h-8 bg-redcliffe rounded-full flex items-center justify-center text-white font-bold text-xs">RL</div>
                                <span class="font-bold text-gray-800">Redcliffe Labs</span>
                            </div>
                        </div>
                        <span class="text-gray-400 font-light text-lg ml-3 border-l pl-3 border-gray-200">IMS Cloud</span>
                    </div>
                </div>
                
                <!-- Right side controls (Mobile Menu Button + Sync) -->
                <div class="flex items-center space-x-2 md:space-x-4">
                    <button onclick="syncData()" class="bg-gray-100 p-2 rounded-full hover:bg-gray-200 transition" title="Refresh Cloud Data">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0014.001 1.077m-1.357 5.865a8 8 0 11-13.333 13.333m8.542-16.666v5h5"></path></svg>
                    </button>

                    <!-- Mobile Menu Button -->
                    <button id="mobileMenuButton" class="md:hidden p-2 rounded hover:bg-gray-100 focus:outline-none" aria-label="Toggle navigation">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Menu Links (Toggled on Mobile) -->
            <div id="mobileMenu" class="hidden md:flex flex-col md:flex-row md:items-center pb-2 md:pb-0 text-sm font-medium border-t md:border-t-0 mt-2 md:mt-0 md:space-x-4">
                <button onclick="showTab('dashboard')" class="nav-link px-3 py-2 text-redcliffe font-bold w-full text-left md:w-auto">Dashboard</button>
                <button onclick="showTab('masters')" class="nav-link px-3 py-2 text-gray-700 hover:text-redcliffe transition w-full text-left md:w-auto">Masters</button>
                <button onclick="showTab('inward')" class="nav-link px-3 py-2 text-gray-700 hover:text-redcliffe transition w-full text-left md:w-auto">Inward Entry</button>
                <button onclick="showTab('outward')" class="nav-link px-3 py-2 text-gray-700 hover:text-redcliffe transition w-full text-left md:w-auto">Outward/Issue</button>
                <button onclick="showTab('inventory')" class="nav-link px-3 py-2 text-gray-700 hover:text-redcliffe transition w-full text-left md:w-auto">Live Inventory</button>
                <button onclick="showTab('expenses')" class="nav-link px-3 py-2 text-gray-700 hover:text-redcliffe transition w-full text-left md:w-auto">Expenses</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-6">

        <!-- DASHBOARD TAB (ADVANCED) -->
        <section id="tab-dashboard" class="tab-content">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6">Inventory Command Center</h1>
            
            <!-- Row 1: Key Performance Indicators (KPIs) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                
                <!-- Card 1: Total Stock Value -->
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-redcliffe flex items-center justify-between">
                    <div>
                        <p class="text-sm uppercase font-semibold text-gray-500">Total Stock Value</p>
                        <h3 id="stat-value" class="text-3xl font-bold mt-1 text-redcliffe">‚Çπ 0</h3>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full text-redcliffe">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m0 0l-1 2h10l-1-2m-9 0a2 2 0 100-4 2 2 0 000 4zm7 0a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                    </div>
                </div>

                <!-- Card 2: Total Items in Stock -->
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-yellow-500 flex items-center justify-between">
                    <div>
                        <p class="text-sm uppercase font-semibold text-gray-500">Total Material Units</p>
                        <h3 id="stat-items" class="text-3xl font-bold mt-1">0</h3>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full text-yellow-600">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                    </div>
                </div>

                <!-- Card 3: Total Hubs Registered -->
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500 flex items-center justify-between">
                    <div>
                        <p class="text-sm uppercase font-semibold text-gray-500">Active Hubs</p>
                        <h3 id="stat-hubs" class="text-3xl font-bold mt-1">0</h3>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full text-blue-600">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                    </div>
                </div>

                <!-- Card 4: Cloud Status -->
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500 flex items-center justify-between">
                    <div>
                        <p class="text-sm uppercase font-semibold text-gray-500">Cloud Sync Status</p>
                        <h3 id="stat-sync" class="text-xl font-bold mt-1 text-green-600">Connected</h3>
                        <p class="text-xs text-gray-400 mt-1">Realtime sheet connection</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full text-green-600">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Column 1 (2/3 width) - Charts & Recent Activity -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- Visualization Placeholder: Stock Value by Category -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                         <h2 class="text-xl font-bold mb-4 flex items-center">üìä Inventory Breakdown by Category (Value)</h2>
                         <div id="stockCategoryChart" class="h-auto min-h-[16rem] flex flex-col items-center justify-center text-gray-400 p-4">
                             <!-- Dynamic Content Placeholder -->
                             <p class="text-lg text-gray-400">Loading chart data...</p>
                         </div>
                    </div>
                    
                    <!-- Recent Transactions Feed -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h2 class="text-xl font-bold mb-4">üöÄ Recent Cloud Activity Feed</h2>
                        <div id="dashboardRecentActivity" class="divide-y divide-gray-100">
                            <!-- Dynamic Content -->
                            <p class="p-4 text-center text-gray-500">Loading recent activity...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Column 2 (1/3 width) - Quick Actions & Alerts -->
                <div class="lg:col-span-1 space-y-6">
                    
                    <!-- Quick Actions -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h2 class="font-bold text-lg mb-4 text-gray-800">Operational Shortcuts</h2>
                        <div class="space-y-3">
                            <button onclick="showTab('inward')" class="w-full p-4 bg-blue-50 rounded-lg text-left hover:bg-blue-600 hover:text-white transition group flex items-center justify-between">
                                <span class="font-semibold">üì¶ New Inward Entry</span>
                                <svg class="w-5 h-5 group-hover:text-white text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                            <button onclick="showTab('outward')" class="w-full p-4 bg-orange-50 rounded-lg text-left hover:bg-orange-600 hover:text-white transition group flex items-center justify-between">
                                <span class="font-semibold">üöö Issue Material (Outward)</span>
                                <svg class="w-5 h-5 group-hover:text-white text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                            </button>
                            <button onclick="showTab('expenses')" class="w-full p-4 bg-green-50 rounded-lg text-left hover:bg-green-600 hover:text-white transition group flex items-center justify-between">
                                <span class="font-semibold">üí∞ Log New Expense</span>
                                <svg class="w-5 h-5 group-hover:text-white text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0v3m0 0v3m0-3h-2m2 0h2m4-3v3m0 0v3m0-3h-2m2 0h2a2 2 0 002-2v-3m-4 0h-4a2 2 0 00-2 2v3m0 0H7a2 2 0 01-2-2V8a2 2 0 012-2h10a2 2 0 012 2v3"></path></svg>
                            </button>
                            <button onclick="syncData()" class="w-full p-4 bg-gray-100 rounded-lg text-left hover:bg-redcliffe hover:text-white transition group flex items-center justify-between">
                                <span class="font-semibold">üîÑ Refresh All Data</span>
                                <svg class="w-5 h-5 group-hover:text-white text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0014.001 1.077m-1.357 5.865a8 8 0 11-13.333 13.333m8.542-16.666v5h5"></path></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Alerts/Info -->
                    <div class="bg-red-50 p-4 rounded-xl shadow-sm border border-red-200">
                        <h3 class="font-bold text-red-700 mb-2 flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.39 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            Stock Alerts
                        </h3>
                        <p class="text-sm text-red-600">Review the 'Live Inventory' tab to check for materials with zero or critically low stock levels (shown in red).</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- MASTERS TAB -->
        <section id="tab-masters" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Hub Master -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold mb-4">üè¢ Hub Master</h3>
                    <form id="hubForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="hubName" placeholder="Hub Name" class="p-2 border rounded w-full" required>
                            <input type="text" id="hubLocation" placeholder="Location/City" class="p-2 border rounded w-full" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="hubSpoc" placeholder="SPOC Name" class="p-2 border rounded w-full" required>
                            <input type="tel" id="hubNumber" placeholder="SPOC Mobile" class="p-2 border rounded w-full" required>
                        </div>
                        <textarea id="hubAddress" placeholder="Full Address" class="p-2 border rounded w-full h-20" required></textarea>
                        <button type="submit" class="w-full bg-redcliffe text-white py-2 rounded font-semibold hover:bg-red-800">Add Hub to Cloud</button>
                    </form>
                    <div class="mt-6 overflow-x-auto max-h-60">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr><th class="p-2 text-left">Hub Name</th><th class="p-2 text-left">Location</th></tr>
                            </thead>
                            <tbody id="hubList"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Material Master -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold mb-4">üì¶ Material Master</h3>
                    <form id="materialForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="matName" placeholder="Material Name" class="p-2 border rounded w-full" required>
                            <select id="matCategory" class="p-2 border rounded w-full" required>
                                <option value="">Select Category</option>
                                <option value="Stationery">Stationery</option>
                                <option value="Medical Consumables">Medical Consumables</option>
                                <option value="Kits">Kits</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Equipment">Equipment</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="matPrice" placeholder="Unit Price (‚Çπ)" class="p-2 border rounded w-full" required>
                            <input type="text" id="matUom" placeholder="UOM (e.g., Pcs, Box, ML)" class="p-2 border rounded w-full" required>
                        </div>
                        <button type="submit" class="w-full bg-redcliffe text-white py-2 rounded font-semibold hover:bg-red-800">Add Material to Cloud</button>
                    </form>
                    <div class="mt-6 overflow-x-auto max-h-60">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr><th class="p-2 text-left">Name</th><th class="p-2 text-left">Price</th></tr>
                            </thead>
                            <tbody id="materialList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- INWARD ENTRY TAB -->
        <section id="tab-inward" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-xl font-bold mb-6">Inward Material Entry</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 border-r pr-0 lg:pr-8">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Inward Type</label>
                            <select id="inwardType" onchange="toggleInwardSource()" class="w-full p-2 border rounded bg-gray-50">
                                <option value="Standard">Standard Dispatch</option>
                                <option value="NoidaWarehouse">Noida Warehouse</option>
                                <option value="CampReturn">Return from Camp</option>
                                <option value="ClinicReturn">Return from Clinic</option>
                            </select>
                        </div>

                        <div id="sourceDetails" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg border-l-4 border-blue-500">
                            <div id="standardSource"><input type="text" id="dispatchFrom" placeholder="Dispatched From (Vendor/Courier)" class="w-full p-2 border rounded"></div>
                            <div id="noidaSource" class="hidden"><input type="text" id="noidaChallan" placeholder="Challan Number" class="w-full p-2 border rounded"></div>
                            <div id="campSource" class="hidden space-y-2">
                                <input type="text" id="campCode" placeholder="Camp Code (Mandatory)" class="w-full p-2 border rounded">
                                <input type="text" id="campClientName" placeholder="Client Name" class="w-full p-2 border rounded">
                            </div>
                            <div id="clinicSource" class="hidden"><input type="text" id="clinicClientName" placeholder="Clinic Client Name" class="w-full p-2 border rounded"></div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Delivery Hub</label>
                            <select id="inwardHub" class="w-full p-2 border rounded hub-select"></select>
                        </div>

                        <h4 class="font-bold mb-2">Add Items</h4>
                        <div class="space-y-2">
                            <select id="cartMaterial" class="w-full p-2 border rounded mat-select"></select>
                            <input type="number" id="cartQty" placeholder="Quantity" class="w-full p-2 border rounded" min="1">
                            <button onclick="addToCart('inward')" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">+ Add to Cart</button>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <h3 class="font-bold text-lg mb-4">Inward Cart</h3>
                        <div class="overflow-x-auto border rounded-lg mb-4">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr><th class="p-3 text-left">Material</th><th class="p-3 text-right">Qty</th><th class="p-3 text-right">Total Value</th><th class="p-3 text-center">Action</th></tr>
                                </thead>
                                <tbody id="inwardCartBody"><tr><td colspan="4" class="p-8 text-center text-gray-400">Cart is empty</td></tr></tbody>
                            </table>
                        </div>
                        <div class="flex justify-end space-x-4 items-center">
                            <div class="text-xl font-bold">Total: ‚Çπ<span id="inwardTotal">0</span></div>
                            <button onclick="processTransaction('inward')" class="bg-redcliffe text-white px-8 py-3 rounded-lg font-bold hover:bg-red-800 shadow-lg">Finalize Inward Entry</button>
                        </div>
                    </div>
                </div>
                <div class="mt-12 overflow-x-auto">
                    <h3 class="font-bold mb-4">Cloud Inward History (Last 5)</h3>
                    <table class="w-full text-xs text-left border" id="inward-history-table">
                        <thead class="bg-gray-50"><tr><th class="p-2">Date</th><th class="p-2">Type</th><th class="p-2">Source</th><th class="p-2">Hub</th><th class="p-2">Items</th></tr></thead>
                        <tbody id="inwardHistoryBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- OUTWARD / ISSUE TAB -->
        <section id="tab-outward" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-xl font-bold mb-6">Material Issue (Outward)</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 border-r pr-0 lg:pr-8">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Issue To</label>
                            <select id="outwardType" onchange="toggleOutwardDest()" class="w-full p-2 border rounded bg-gray-50">
                                <option value="Camp">Camp</option>
                                <option value="Clinic">Clinic</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Issue From Hub</label>
                            <select id="outwardHub" class="w-full p-2 border rounded hub-select"></select>
                        </div>
                        <div id="outwardDestDetails" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            <div id="campDest" class="space-y-4">
                                <input type="text" id="oCampCode" placeholder="Camp Code (Required)" class="w-full p-2 border rounded" required>
                                <input type="text" id="oCampClient" placeholder="Client Name" class="w-full p-2 border rounded">
                                <input type="text" id="oCampCity" placeholder="City" class="w-full p-2 border rounded">
                                <input type="text" id="oCampAddress" placeholder="Address" class="w-full p-2 border rounded">
                                <input type="text" id="oCampSPOC" placeholder="SPOC Name" class="w-full p-2 border rounded">
                                <input type="text" id="oCampSPOCNumber" placeholder="SPOC Number" class="w-full p-2 border rounded">
                            </div>
                            <div id="clinicDest" class="hidden"><input type="text" id="oClinicClient" placeholder="Clinic Name (Required)" class="w-full p-2 border rounded" required></div>
                            <input type="text" id="oRequestBy" placeholder="Material Requested By (Your Name/Staff Code)" class="w-full p-2 border rounded font-semibold border-blue-200" required>
                        </div>
                        <h4 class="font-bold mb-2">Add Items</h4>
                        <div class="space-y-2">
                            <select id="outCartMaterial" class="w-full p-2 border rounded mat-select"></select>
                            <input type="number" id="outCartQty" placeholder="Quantity" class="w-full p-2 border rounded" min="1">
                            <button onclick="addToCart('outward')" class="w-full bg-orange-600 text-white py-2 rounded hover:bg-orange-700">+ Add to Cart</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <h3 class="font-bold text-lg mb-4">Outward Cart</h3>
                        <div class="overflow-x-auto border rounded-lg mb-4">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100"><tr><th class="p-3 text-left">Material</th><th class="p-3 text-right">Qty</th><th class="p-3 text-center">Action</th></tr></thead>
                                <tbody id="outwardCartBody"><tr><td colspan="3" class="p-8 text-center text-gray-400">Cart is empty</td></tr></tbody>
                            </table>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="processTransaction('outward')" class="bg-redcliffe text-white px-8 py-3 rounded-lg font-bold hover:bg-red-800 shadow-lg">Finalize Issue Material</button>
                        </div>
                    </div>
                </div>
                <div class="mt-12 overflow-x-auto">
                    <h3 class="font-bold mb-4">Cloud Outward History (Last 5)</h3>
                    <table class="w-full text-xs text-left border" id="outward-history-table">
                        <thead class="bg-gray-50"><tr><th class="p-2">Date</th><th class="p-2">To</th><th class="p-2">Destination</th><th class="p-2">Requested By</th><th class="p-2">Hub</th><th class="p-2">Items</th></tr></thead>
                        <tbody id="outwardHistoryBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- LIVE INVENTORY TAB -->
        <section id="tab-inventory" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Live Cloud Inventory</h2>
                    <select id="inventoryHubFilter" onchange="renderInventory()" class="p-2 border rounded bg-gray-50 hub-select">
                        <option value="all">All Hubs (Aggregated View)</option>
                    </select>
                </div>
                <div class="overflow-x-auto border rounded-xl">
                    <table id="inventory-table" class="w-full text-sm">
                        <thead class="bg-gray-800 text-white">
                            <!-- Header content is dynamically set by renderInventory() -->
                            <tr><th class="p-3">Hub Name</th><th class="p-3">Material</th><th class="p-3">Category</th><th class="text-right p-3">Stock</th><th class="p-3">UOM</th><th class="text-right p-3">Value</th></tr>
                        </thead>
                        <tbody id="inventoryBody" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- EXPENSES TAB -->
        <section id="tab-expenses" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h2 class="text-xl font-bold mb-6">Expense Ledger Entry</h2>
                
                <!-- Updated Expense Form -->
                <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8 p-4 border rounded-lg bg-gray-50">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">Date</label>
                        <input type="date" id="expDate" class="w-full p-2 border rounded" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">Hub/Location</label>
                        <select id="expHub" class="w-full p-2 border rounded hub-select" required>
                            <option value="">Select Hub</option>
                        </select>
                    </div>
                    
                    <!-- Enhanced Invoice/Attachment instructions -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">Invoice Ref / Attachment Link</label>
                        <input type="text" id="expInvoiceId" placeholder="Paste Google Drive/Cloud URL or Reference ID" class="w-full p-2 border rounded" required>
                        <p class="text-xs text-gray-500 mt-1 px-1 text-red-500 font-medium">
                            (For file attachments: Upload PDF/JPG to Google Drive first, then paste the sharing link here.)
                        </p>
                    </div>
                    
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium mb-1">Category</label>
                        <select id="expCategory" onchange="toggleTransportFields()" class="w-full p-2 border rounded" required>
                            <option value="">Select Category</option>
                            <option value="Material Transportation">Material Transportation</option>
                            <option value="Travel">Travel</option>
                            <option value="Fuel">Fuel</option>
                            <option value="Food">Food/Refreshment</option>
                            <option value="Maintenance">Equipment Maintenance</option>
                            <option value="Miscellaneous">Miscellaneous</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium mb-1">Amount (‚Çπ)</label>
                        <input type="number" id="expAmount" placeholder="Amount" class="w-full p-2 border rounded" required min="1">
                    </div>

                    <!-- Conditional Fields for Material Transportation -->
                    <div id="transportFields" class="md:col-span-6 grid grid-cols-1 md:grid-cols-2 gap-4 hidden border-t pt-4 mt-2">
                        <div>
                            <label class="block text-sm font-medium mb-1">From Address</label>
                            <input type="text" id="expFromAddress" placeholder="Starting Location (e.g., Noida Warehouse)" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">To Address</label>
                            <input type="text" id="expToAddress" placeholder="Destination Location (e.g., Delhi Hub/Client Site)" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    
                    <div class="md:col-span-4">
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <input type="text" id="expDescription" placeholder="Detailed purpose of expense (e.g., Courier charges, CNG refill)" class="w-full p-2 border rounded" required>
                    </div>
                    <div class="md:col-span-2 flex items-end">
                         <button type="submit" class="w-full bg-green-600 text-white py-2 rounded font-semibold hover:bg-green-700">Log Expense</button>
                    </div>
                </form>

                <div class="mt-8 overflow-x-auto">
                    <h3 class="font-bold mb-4">Cloud Expense History (Last 100 Entries)</h3>
                    <table class="w-full text-xs text-left border" id="expense-history-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-2">Date</th>
                                <th class="p-2">Hub</th>
                                <th class="p-2">Invoice Link/Ref</th>
                                <th class="p-2">Category</th>
                                <th class="p-2">Description/Route</th>
                                <th class="p-2 text-right">Amount (‚Çπ)</th>
                            </tr>
                        </thead>
                        <tbody id="expenseHistoryBody">
                            <tr><td colspan="6" class="p-4 text-center text-gray-400">Loading expenses...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="toast" class="fixed bottom-5 right-5 hidden px-6 py-3 rounded-lg shadow-2xl text-white font-bold z-[100]"></div>

    <script>
        /** CONFIGURATION: Paste your Google Web App URL here **/
        const SHEET_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzZVk75GvHuLEVlEl0_334SbZQyAlv77fjMjZauUyxbU2dqXBiV8U3HXflf0Ll7HU2R/exec";
        const STAFF_CODE = "9799";

        // Local State
        let hubs = [];
        let materials = [];
        let inventory = {};
        let inwardHistory = [];
        let outwardHistory = [];
        let expenseLedger = []; 
        let activeInwardCart = [];
        let activeOutwardCart = [];
        let grandTotalValue = 0; // Global state for Dashboard KPI

        // App Initializer
        window.onload = function() {
            syncData();
            setupMobileMenuToggle();
            setDefaultDate(); 
        };

        function setupMobileMenuToggle() {
            const button = document.getElementById('mobileMenuButton');
            const menu = document.getElementById('mobileMenu');
            
            button.addEventListener('click', () => {
                menu.classList.toggle('hidden');
            });

            // Close menu when a link is clicked (on mobile)
            menu.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Check if Tailwind's 'md' breakpoint (768px) is not met
                    if (window.innerWidth < 768) { 
                        menu.classList.add('hidden');
                    }
                });
            });
        }
        
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            const expDate = document.getElementById('expDate');
            if (expDate) {
                expDate.value = today;
            }
        }


        async function syncData() {
            if (!SHEET_SCRIPT_URL.startsWith("https")) {
                toast("Please set the SHEET_SCRIPT_URL first!", "error");
                return;
            }
            showLoading(true);
            try {
                const response = await fetch(`${SHEET_SCRIPT_URL}?action=getData`);
                const data = await response.json();
                
                hubs = data.hubs || [];
                materials = data.materials || [];
                inventory = data.inventory || {};
                inwardHistory = data.inwards || [];
                outwardHistory = data.outwards || [];
                expenseLedger = data.expenses || []; 

                updateDropdowns();
                renderMasters();
                renderInventory(); // This updates grandTotalValue and the Inventory tab
                renderHistory(); // <--- FIX APPLIED HERE
                renderExpenses(); 
                updateDashboardStats(); // Updates stat-hubs and stat-items
                renderDashboardActivity(); // Updates chart and activity feed
                toast("Cloud Data Synced");
            } catch (err) {
                console.error(err);
                toast("Sync failed. Check App Script Deployment.", "error");
            } finally {
                showLoading(false);
            }
        }

        async function saveMaster(type, data) {
            showLoading(true);
            try {
                await fetch(SHEET_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'saveMaster', type, data })
                });
                toast(`Saving ${type}...`);
                setTimeout(syncData, 2000);
            } catch (err) { toast("Error saving master", "error"); }
        }
        
        async function logExpense(data) {
            showLoading(true);
            const hubName = hubs.find(h => h.id == data.hubId)?.name || 'Unknown';
            try {
                await fetch(SHEET_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        action: 'logExpense',
                        data: {
                            date: data.date,
                            hubId: data.hubId,
                            hubName: hubName,
                            category: data.category,
                            amount: data.amount,
                            description: data.description,
                            invoiceId: data.invoiceId, 
                            fromAddress: data.fromAddress,
                            toAddress: data.toAddress,
                            staffCode: STAFF_CODE 
                        }
                    })
                });
                toast("Expense logged successfully. Syncing data...");
                setTimeout(syncData, 2500);
            } catch (err) {
                toast("Error logging expense", "error");
            }
        }


        async function processTransaction(type) {
            const hubId = document.getElementById(type === 'inward' ? 'inwardHub' : 'outwardHub').value;
            const cart = type === 'inward' ? activeInwardCart : activeOutwardCart;

            if(!hubId || cart.length === 0) return toast("Missing details or empty cart", "error");

            let sourceInfo = "";
            let reqBy = "";
            let destinationDetails = {};
            let transactionType = document.getElementById(type === 'inward' ? 'inwardType' : 'outwardType').value;

            if(type === 'inward') {
                if(transactionType === 'Standard') sourceInfo = document.getElementById('dispatchFrom').value;
                else if(transactionType === 'NoidaWarehouse') sourceInfo = "Challan: " + document.getElementById('noidaChallan').value;
                else if(transactionType === 'CampReturn') sourceInfo = "Camp: " + document.getElementById('campCode').value;
                else sourceInfo = "Clinic: " + document.getElementById('clinicClientName').value;
                
                // Set default if sourceInfo is empty
                if (!sourceInfo) sourceInfo = `(${transactionType} Entry)`;
            } else {
                reqBy = document.getElementById('oRequestBy').value;
                if(!reqBy) return toast("Requester name required", "error");
                
                if (transactionType === 'Camp') {
                    sourceInfo = document.getElementById('oCampCode').value;
                    destinationDetails = {
                        client: document.getElementById('oCampClient').value,
                        city: document.getElementById('oCampCity').value,
                        address: document.getElementById('oCampAddress').value,
                        spoc: document.getElementById('oCampSPOC').value,
                        number: document.getElementById('oCampSPOCNumber').value,
                    };
                    if (!sourceInfo) return toast("Camp Code is required for outward camp entry", "error");
                } else if (transactionType === 'Clinic') {
                    sourceInfo = document.getElementById('oClinicClient').value;
                    if (!sourceInfo) return toast("Clinic Name is required for outward clinic entry", "error");
                }
            }

            showLoading(true);
            try {
                await fetch(SHEET_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        action: 'transaction',
                        type, hubId, sourceInfo, reqBy,
                        transactionType: transactionType,
                        items: cart,
                        date: new Date().toLocaleString(),
                        destinationDetails: destinationDetails // Pass destination details for outward
                    })
                });
                if(type === 'inward') activeInwardCart = []; else activeOutwardCart = [];
                renderCart(type);
                toast("Submitting to Cloud...");
                setTimeout(syncData, 2500);
            } catch (err) { toast("Transaction failed", "error"); }
        }

        // Feature: Cart Logic
        function addToCart(transType) {
            const matSelect = document.getElementById(transType === 'inward' ? 'cartMaterial' : 'outCartMaterial');
            const matId = matSelect.value;
            const qtyInput = document.getElementById(transType === 'inward' ? 'cartQty' : 'outCartQty');
            const qty = parseInt(qtyInput.value);
            
            if(!matId || isNaN(qty) || qty <= 0) return toast("Invalid quantity or material selection", "error");
            
            const mat = materials.find(m => m.id == matId);
            const cart = transType === 'inward' ? activeInwardCart : activeOutwardCart;
            
            // Check stock only for outward transactions
            if (transType === 'outward') {
                const hubId = document.getElementById('outwardHub').value;
                if (!hubId) return toast("Select an Issue From Hub first.", "error");
                const stockKey = `${hubId}_${matId}`;
                const currentStock = inventory[stockKey] || 0;
                
                let quantityInCart = 0;
                const existingItem = cart.find(item => item.id === matId);
                if (existingItem) {
                    quantityInCart = existingItem.qty;
                }
                
                if (currentStock < (quantityInCart + qty)) {
                    return toast(`Insufficient stock. Only ${currentStock} units available at this hub.`, "error");
                }
            }


            // Check for duplicate material in cart
            const existingItemIndex = cart.findIndex(item => item.id === matId);

            if (existingItemIndex !== -1) {
                cart[existingItemIndex].qty += qty;
            } else {
                cart.push({ ...mat, qty });
            }

            // Clear inputs after adding to cart
            qtyInput.value = '';
            matSelect.selectedIndex = 0;

            renderCart(transType);
        }

        function renderCart(type) {
            const cart = type === 'inward' ? activeInwardCart : activeOutwardCart;
            const body = document.getElementById(type + 'CartBody');
            let total = 0;
            if(cart.length === 0) {
                body.innerHTML = `<tr><td colspan="${type==='inward' ? 4 : 3}" class="p-8 text-center text-gray-400">Cart is empty</td></tr>`;
                if(type === 'inward') document.getElementById('inwardTotal').innerText = '0';
                return;
            }
            body.innerHTML = cart.map((item, idx) => {
                const itemTotal = item.qty * item.price;
                total += itemTotal;
                return `<tr class="border-b">
                    <td class="p-3">${item.name}</td>
                    <td class="p-3 text-right">${item.qty}</td>
                    ${type==='inward'?`<td class="p-3 text-right">‚Çπ${itemTotal.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>`:''} 
                    <td class="p-3 text-center"><button onclick="removeFromCart('${type}', ${idx})" class="text-red-500 hover:text-red-700">‚úï</button></td>
                </tr>`;
            }).join('');
            
            if(type === 'inward') document.getElementById('inwardTotal').innerText = total.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }

        function removeFromCart(type, idx) {
            if(type === 'inward') activeInwardCart.splice(idx, 1); else activeOutwardCart.splice(idx, 1);
            renderCart(type);
        }

        // Feature: UI Rendering
        function renderMasters() {
            document.getElementById('hubList').innerHTML = hubs.map(h => `<tr class="border-b"><td class="p-2">${h.name}</td><td class="p-2">${h.location}</td></tr>`).join('');
            document.getElementById('materialList').innerHTML = materials.map(m => `<tr class="border-b"><td class="p-2">${m.name}</td><td class="p-2">‚Çπ${parseFloat(m.price).toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td></tr>`).join('');
        }
        
        function calculateStockBreakdown() {
            let breakdown = {};
            let totalItems = 0;
            grandTotalValue = 0; 

            hubs.forEach(hub => {
                materials.forEach(mat => {
                    const key = `${hub.id}_${mat.id}`;
                    const qty = inventory[key] || 0;
                    const category = mat.category || 'Uncategorized';
                    const price = parseFloat(mat.price) || 0;
                    
                    if (qty > 0) {
                        if (!breakdown[category]) {
                            breakdown[category] = { count: 0, value: 0 };
                        }
                        breakdown[category].count += qty;
                        breakdown[category].value += qty * price;
                        grandTotalValue += qty * price;
                        totalItems += qty;
                    }
                });
            });
            
            return { breakdown, totalItems };
        }


        function renderInventory() {
            const { breakdown, totalItems } = calculateStockBreakdown();
            
            // Update Dashboard Global Stats
            document.getElementById('stat-value').innerText = "‚Çπ " + grandTotalValue.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            document.getElementById('stat-items').innerText = totalItems.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0});


            const filter = document.getElementById('inventoryHubFilter').value;
            const body = document.getElementById('inventoryBody');
            let html = "";
            const isAllHubsView = (filter === 'all' || filter === ''); 

            // --- 2. Render Table View ---
            const tableHeadRow = document.querySelector('#inventory-table thead tr');
            let displayedItemsCount = 0;
            
            if (isAllHubsView) {
                // AGGREGATED VIEW: Display total stock per material across all hubs
                
                tableHeadRow.innerHTML = `
                    <th class="p-3">Material</th>
                    <th class="p-3">Category</th>
                    <th class="text-right p-3">Total Stock</th>
                    <th class="p-3">UOM</th>
                    <th class="text-right p-3">Total Value</th>
                `;

                materials.forEach(mat => {
                    let totalQty = 0;
                    
                    hubs.forEach(hub => {
                        const key = `${hub.id}_${mat.id}`;
                        totalQty += (inventory[key] || 0);
                    });
                    
                    // Only show materials that have stock somewhere or are explicitly requested
                    if (totalQty > 0 || materials.length < 50) { 
                        displayedItemsCount++;
                        const price = parseFloat(mat.price) || 0;
                        const totalValue = totalQty * price;
                        
                        html += `<tr class="hover:bg-gray-50 ${totalQty === 0 ? 'bg-red-50/50' : ''}">
                            <td class="p-3">${mat.name}</td>
                            <td class="p-3">${mat.category}</td>
                            <td class="text-right p-3 font-bold ${totalQty === 0 ? 'text-red-600' : ''}">${totalQty.toLocaleString()}</td>
                            <td class="p-3">${mat.uom}</td>
                            <td class="text-right p-3">‚Çπ${totalValue.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                        </tr>`;
                    }
                });

            } else {
                // DETAILED VIEW: Specific Hub selected. Show all defined materials (including zero stock)
                
                tableHeadRow.innerHTML = `
                    <th class="p-3">Hub Name</th>
                    <th class="p-3">Material</th>
                    <th class="p-3">Category</th>
                    <th class="text-right p-3">Stock</th>
                    <th class="p-3">UOM</th>
                    <th class="text-right p-3">Value</th>
                `;

                const hubToRender = hubs.find(h => h.id == filter);
                
                if (hubToRender) {
                    materials.forEach(mat => {
                        const key = `${hubToRender.id}_${mat.id}`;
                        const qty = inventory[key] || 0;
                        
                        displayedItemsCount++; 
                        const price = parseFloat(mat.price) || 0;
                        const val = qty * price;
                        
                        html += `<tr class="hover:bg-gray-50 ${qty === 0 ? 'bg-red-50/50' : ''}">
                            <td class="p-3">${hubToRender.name}</td>
                            <td class="p-3">${mat.name}</td>
                            <td class="p-3">${mat.category}</td>
                            <td class="text-right p-3 font-bold ${qty === 0 ? 'text-red-600' : ''}">${qty.toLocaleString()}</td>
                            <td class="p-3">${mat.uom}</td>
                            <td class="text-right p-3">‚Çπ${val.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                        </tr>`;
                    });
                }
            }
            
            if (displayedItemsCount === 0) {
                 const colSpan = isAllHubsView ? 5 : 6;
                 html = `<tr><td colspan="${colSpan}" class="p-8 text-center text-gray-400">No stock found matching the filter.</td></tr>`;
            }
            body.innerHTML = html;
        }
        
        function renderStockBreakdownChart() {
            const { breakdown, totalItems } = calculateStockBreakdown();
            const chartEl = document.getElementById('stockCategoryChart');
            
            if (totalItems === 0) {
                chartEl.innerHTML = `<p class="text-lg text-gray-400">Inventory data is currently empty.</p>`;
                return;
            }
            
            // Convert breakdown object to an array of { category, percentage, value }
            const categories = Object.keys(breakdown).map(cat => ({
                category: cat,
                value: breakdown[cat].value,
                percentage: ((breakdown[cat].value / grandTotalValue) * 100).toFixed(1)
            })).sort((a, b) => b.value - a.value); // Sort by value desc

            let chartHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">
            `;
            
            categories.slice(0, 6).forEach(cat => { // Limit to top 6 categories
                // Cap bar width at 100%
                const barWidth = Math.min(100, parseFloat(cat.percentage));
                const valueDisplay = '‚Çπ' + cat.value.toLocaleString('en-IN', { notation: 'compact', maximumSignificantDigits: 3 });
                
                chartHTML += `
                    <div class="space-y-1">
                        <div class="flex justify-between items-center text-sm font-medium">
                            <span class="text-gray-600">${cat.category}</span>
                            <span class="font-bold text-redcliffe">${cat.percentage}%</span>
                        </div>
                        <div class="h-3 bg-gray-200 rounded-full">
                            <div style="width: ${barWidth}%;" class="h-full bg-redcliffe rounded-full transition-all duration-500 shadow-md"></div>
                        </div>
                        <p class="text-xs text-gray-400">${valueDisplay} Total Value</p>
                    </div>
                `;
            });

            chartHTML += `</div>`;
            chartEl.innerHTML = chartHTML;
        }

        
        function renderExpenses() {
            const body = document.getElementById('expenseHistoryBody');
            if (expenseLedger.length === 0) {
                body.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-400">No expenses logged yet.</td></tr>`;
                return;
            }
            
            const isURL = (str) => {
                // Simple URL check for display purposes
                return str && (str.startsWith('http://') || str.startsWith('https://'));
            };


            body.innerHTML = expenseLedger.slice(0, 100).map(e => {
                const amount = parseFloat(e.amount);
                let descriptionCell = e.description;

                // Check for transportation details and format description
                if (e.category === 'Material Transportation' && e.fromAddress && e.toAddress) {
                    descriptionCell = `Route: ${e.fromAddress} <span class="text-gray-400">-></span> ${e.toAddress} <br><span class="text-xs text-gray-500">${e.description}</span>`;
                }
                
                // Handle Invoice Link/Ref
                let invoiceCellContent;
                if (e.invoiceId && isURL(e.invoiceId)) {
                    invoiceCellContent = `<a href="${e.invoiceId}" target="_blank" class="text-blue-600 hover:text-blue-800 underline font-semibold text-xs">View Link</a>`;
                } else {
                    invoiceCellContent = `<span class="font-mono text-xs">${e.invoiceId || 'N/A'}</span>`;
                }


                return `<tr class="border-b hover:bg-red-50">
                    <td class="p-2 whitespace-nowrap">${e.date}</td>
                    <td class="p-2">${e.hubName}</td>
                    <td class="p-2">${invoiceCellContent}</td> 
                    <td class="p-2">${e.category}</td>
                    <td class="p-2">${descriptionCell}</td>
                    <td class="p-2 text-right font-semibold text-red-600">‚Çπ${amount.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                </tr>`;
            }).join('');
        }


        function renderHistory() {
            // FIX: Added checks for empty arrays and robust property access with fallbacks.
            const inwardBody = document.getElementById('inwardHistoryBody');
            if (inwardHistory.length === 0) {
                inwardBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">No inward history found.</td></tr>`;
            } else {
                // Assuming properties: date, type (transactionType), sourceInfo, hubName, items
                inwardBody.innerHTML = inwardHistory.slice(0, 5).map(h => `<tr class="border-b hover:bg-gray-50">
                    <td class="p-2 whitespace-nowrap">${h.date || 'N/A'}</td>
                    <td class="p-2">${h.type || 'N/A'}</td>
                    <td class="p-2">${h.sourceInfo || 'N/A'}</td>
                    <td class="p-2">${h.hubName || 'Unknown Hub'}</td>
                    <td class="p-2">${h.items || 0}</td>
                </tr>`).join('');
            }

            const outwardBody = document.getElementById('outwardHistoryBody');
            if (outwardHistory.length === 0) {
                outwardBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-400">No outward history found.</td></tr>`;
            } else {
                // Assuming properties: date, to (destination type), dest (name/code), req (requested by), hub (issuing hub name), items
                outwardBody.innerHTML = outwardHistory.slice(0, 5).map(h => `<tr class="border-b hover:bg-gray-50">
                    <td class="p-2 whitespace-nowrap">${h.date || 'N/A'}</td>
                    <td class="p-2">${h.to || 'N/A'}</td>
                    <td class="p-2">${h.dest || 'N/A'}</td>
                    <td class="p-2">${h.req || 'N/A'}</td>
                    <td class="p-2">${h.hub || 'Unknown Hub'}</td>
                    <td class="p-2">${h.items || 0}</td>
                </tr>`).join('');
            }
        }
        
        function renderDashboardActivity() {
            const activityBody = document.getElementById('dashboardRecentActivity');
            
            // Combine and sort recent transactions
            const combinedHistory = [
                ...inwardHistory.slice(0, 10).map(i => ({...i, type: 'INWARD', dateObj: new Date(i.date)})),
                ...outwardHistory.slice(0, 10).map(o => ({...o, type: 'OUTWARD', dateObj: new Date(o.date)}))
            ].sort((a, b) => b.dateObj - a.dateObj).slice(0, 7); // Show 7 most recent overall

            if (combinedHistory.length === 0) {
                activityBody.innerHTML = `<p class="p-4 text-center text-gray-500">No recent activity found.</p>`;
                return;
            }

            activityBody.innerHTML = combinedHistory.map(item => {
                const isOutward = item.type === 'OUTWARD';
                const color = isOutward ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800';
                const icon = isOutward ? 'üöö' : 'üì¶';
                const description = isOutward 
                    ? `Issued to ${item.dest || 'N/A'} (${item.to || 'N/A'}) from ${item.hub || 'N/A'}`
                    : `Received (${item.type || 'N/A'}) at ${item.hubName || 'N/A'} from ${item.sourceInfo || 'N/A'}`;
                
                // Handle invalid dates gracefully
                const itemDate = item.dateObj && !isNaN(item.dateObj) 
                    ? item.dateObj.toLocaleDateString('en-GB') + ' ' + item.dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    : 'Unknown Date';

                return `
                    <div class="flex items-start space-x-4 p-3 hover:bg-gray-50">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full ${color} flex-shrink-0 font-semibold">${icon}</div>
                        <div class="flex-grow">
                            <p class="font-semibold text-sm">${description}</p>
                            <p class="text-xs text-gray-500 mt-1">${item.items || 0} items recorded. <span class="ml-2">${itemDate}</span></p>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Render Stock Chart 
            renderStockBreakdownChart();
        }

        function updateDropdowns() {
            const hSel = document.querySelectorAll('.hub-select');
            const mSel = document.querySelectorAll('.mat-select');
            hSel.forEach(s => s.innerHTML = (s.id==='inventoryHubFilter'?'<option value="all">All Hubs (Aggregated View)</option>':'<option value="">Select Hub</option>') + hubs.map(h=>`<option value="${h.id}">${h.name}</option>`).join(''));
            mSel.forEach(s => s.innerHTML = '<option value="">Select Material</option>' + materials.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''));
        }

        function updateDashboardStats() {
            document.getElementById('stat-hubs').innerText = hubs.length;
            // stat-value and stat-items are updated inside renderInventory()
        }

        // Feature: UI Toggles
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            
            // Update active navigation class
            document.querySelectorAll('.nav-link').forEach(el => {
                el.classList.remove('text-redcliffe', 'font-bold');
                el.classList.add('text-gray-700');
            });
            document.querySelector(`#mobileMenu button[onclick="showTab('${id}')"]`).classList.add('text-redcliffe', 'font-bold');
            document.querySelector(`#mobileMenu button[onclick="showTab('${id}')"]`).classList.remove('text-gray-700');
            
            // Re-render inventory if switching to its tab, to handle default view state
            if (id === 'inventory') {
                renderInventory();
            }
        }

        function toggleInwardSource() {
            const v = document.getElementById('inwardType').value;
            ['standardSource','noidaSource','campSource','clinicSource'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            if(v==='Standard') document.getElementById('standardSource').classList.remove('hidden');
            else if(v==='NoidaWarehouse') document.getElementById('noidaSource').classList.remove('hidden');
            else if(v==='CampReturn') document.getElementById('campSource').classList.remove('hidden');
            else document.getElementById('clinicSource').classList.remove('hidden');
        }

        function toggleOutwardDest() {
            const v = document.getElementById('outwardType').value;
            const isCamp = v === 'Camp';
            document.getElementById('campDest').classList.toggle('hidden', !isCamp);
            document.getElementById('clinicDest').classList.toggle('hidden', isCamp);
            
            // Required attribute handling
            document.getElementById('oCampCode').required = isCamp;
            document.getElementById('oClinicClient').required = !isCamp;
        }

        function toggleTransportFields() {
            const category = document.getElementById('expCategory').value;
            const transportDiv = document.getElementById('transportFields');
            const isTransport = category === 'Material Transportation';
            
            transportDiv.classList.toggle('hidden', !isTransport);
            
            // Set required attribute based on category
            document.getElementById('expFromAddress').required = isTransport;
            document.getElementById('expToAddress').required = isTransport;
        }


        function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
        
        function toast(msg, type = 'success') {
            const el = document.getElementById('toast');
            el.innerText = msg;
            el.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-2xl text-white font-bold z-[100] ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        document.getElementById('hubForm').onsubmit = function(e) {
            e.preventDefault();
            const data = { 
                id: Date.now(), 
                name: document.getElementById('hubName').value, 
                location: document.getElementById('hubLocation').value,
                spoc: document.getElementById('hubSpoc').value,
                number: document.getElementById('hubNumber').value,
                address: document.getElementById('hubAddress').value
            };
            saveMaster('Hub', data);
            e.target.reset();
        };

        document.getElementById('materialForm').onsubmit = function(e) {
            e.preventDefault();
            const data = { 
                id: Date.now(), 
                name: document.getElementById('matName').value, 
                category: document.getElementById('matCategory').value,
                price: parseFloat(document.getElementById('matPrice').value),
                uom: document.getElementById('matUom').value
            };
            saveMaster('Material', data);
            e.target.reset();
        };
        
        document.getElementById('expenseForm').onsubmit = function(e) {
            e.preventDefault();
            const category = document.getElementById('expCategory').value;
            
            const data = {
                date: document.getElementById('expDate').value,
                hubId: document.getElementById('expHub').value,
                category: category,
                amount: parseFloat(document.getElementById('expAmount').value),
                description: document.getElementById('expDescription').value,
                // We keep the key 'invoiceId' but it now accepts the URL or Ref ID
                invoiceId: document.getElementById('expInvoiceId').value, 
                fromAddress: category === 'Material Transportation' ? document.getElementById('expFromAddress').value : '',
                toAddress: category === 'Material Transportation' ? document.getElementById('expToAddress').value : ''
            };
            
            if (!data.date || !data.hubId || !data.category || isNaN(data.amount) || data.amount <= 0 || !data.invoiceId) {
                return toast("Please fill all required expense fields (Date, Hub, Category, Amount, Invoice Ref/Link).", "error");
            }
            
            if (category === 'Material Transportation') {
                if (!data.fromAddress || !data.toAddress) {
                    return toast("Please specify both From and To addresses for Material Transportation.", "error");
                }
            }


            logExpense(data);
            e.target.reset();
            setDefaultDate();
            toggleTransportFields(); // Hide fields after reset
        };


        // Initialize default tab appearance
        showTab('dashboard'); 

    </script>
</body>
</html>

